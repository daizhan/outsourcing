/*! layer mobile v2.0 弹层组件移动版
 * 扩展列表
 * 1. className 选项设置在最外层元素
 * 2. 新增方法topNotify 等同于 layer.open({className: "top-notify top-xxx-notify"}), xxx 为传过过来notify 类型， 可以是info/error/success 之一
 */

/*! layer mobile v2.0 弹层组件移动版
 * 扩展列表
 * 1. className 选项设置在最外层元素
 * 2. 新增方法topNotify 等同于 layer.open({className: "top-notify top-xxx-notify"}), xxx 为传过过来notify 类型， 可以是info/error/success 之一
 */


define("layer",[],function(){"use strict";var e=document,t="querySelectorAll",i="getElementsByClassName",s=function(i){return e[t](i)},n={type:0,shade:!0,shadeClose:!0,fixed:!0,anim:"scale"},o={extend:function(e){var t=JSON.parse(JSON.stringify(n));for(var i in e)t[i]=e[i];return t},timer:{},end:{}};o.touch=function(e,t){e.addEventListener("click",function(e){t.call(this,e)},!1)};var r=0,a=["layui-m-layer"],l=function(e){var t=this;t.config=o.extend(e),t.config.className?t.config.className=[a[0],t.config.className]:t.config.className=a,t.view()};l.prototype.view=function(){var t=this,n=t.config,o=e.createElement("div");t.id=o.id=a[0]+r,o.setAttribute("class",t.config.className.join(" ")+" "+a[0]+(n.type||0)),o.setAttribute("index",r);var l=function(){var e="object"==typeof n.title;return n.title?'<h3 style="'+(e?n.title[1]:"")+'">'+(e?n.title[0]:n.title)+"</h3>":""}(),d=function(){"string"==typeof n.btn&&(n.btn=[n.btn]);var e,t=(n.btn||[]).length;return 0!==t&&n.btn?(e='<span yes type="1">'+n.btn[0]+"</span>",2===t&&(e='<span no type="0">'+n.btn[1]+"</span>"+e),'<div class="layui-m-layerbtn">'+e+"</div>"):""}();if(n.fixed||(n.top=n.hasOwnProperty("top")?n.top:100,n.style=n.style||"",n.style+=" top:"+(e.body.scrollTop+n.top)+"px"),2===n.type&&(n.content='<i></i><i class="layui-m-layerload"></i><i></i><p>'+(n.content||"")+"</p>"),n.skin&&(n.anim="up"),"msg"===n.skin&&(n.shade=!1),o.innerHTML=(n.shade?"<div "+("string"==typeof n.shade?'style="'+n.shade+'"':"")+' class="layui-m-layershade"></div>':"")+'<div class="layui-m-layermain" '+(n.fixed?"":'style="position:static;"')+'><div class="layui-m-layersection"><div class="layui-m-layerchild '+(n.skin?"layui-m-layer-"+n.skin+" ":"")+" "+(n.anim?"layui-m-anim-"+n.anim:"")+'" '+(n.style?'style="'+n.style+'"':"")+">"+l+'<div class="layui-m-layercont">'+n.content+"</div>"+d+"</div></div></div>",!n.type||2===n.type){var u=e[i](a[0]+n.type),h=u.length;h>=1&&c.close(u[0].getAttribute("index"))}document.body.appendChild(o);var f=t.elem=s("#"+t.id)[0];n.success&&n.success(f),t.index=r++,t.action(n,f)},l.prototype.action=function(e,t){var s=this;e.time&&(o.timer[s.index]=setTimeout(function(){c.close(s.index)},1e3*e.time));var n=function(){var t=this.getAttribute("type");0==t?(e.no&&e.no(),c.close(s.index)):e.yes?e.yes(s.index):c.close(s.index)};if(e.btn)for(var r=t[i]("layui-m-layerbtn")[0].children,a=r.length,l=0;l<a;l++)o.touch(r[l],n);if(e.shade&&e.shadeClose){var d=t[i]("layui-m-layershade")[0];o.touch(d,function(){c.close(s.index,e.end)})}e.end&&(o.end[s.index]=e.end)};var c={v:"2.0",index:r,open:function(e){var t=new l(e||{});return t.index},topNotify:function(e,t){t.className="top-notify top-"+e+"-notify",this.open(t)},close:function(t){var i=s("#"+a[0]+t)[0];i&&(i.innerHTML="",e.body.removeChild(i),clearTimeout(o.timer[t]),delete o.timer[t],"function"==typeof o.end[t]&&o.end[t](),delete o.end[t])},closeAll:function(){for(var t=e[i](a[0]),s=0,n=t.length;s<n;s++)c.close(0|t[0].getAttribute("index"))}};return c}),define("utils",["jquery"],function(e){return{encodeHtmlAttr:function(e){return e.replace(/'|"/g,function(e){return'"'==e?"&quot;":"&#39;"})},encodeHtml:function(t){return e("<div></div>").text(t).html()},encodeHtmlAndAttr:function(t){return this.encodeHtmlAttr(e("<div></div>").text(t).html())},count:function(){var e=0;return function(t){return t="undefined"!=typeof t?t||0:1,e+=t}}(),distance:function(e,t){},getRectPoints:function(e,t){var i=Math.min(e.x,t.x),s=Math.min(e.y,t.y),n=Math.max(e.x,t.x),o=Math.max(e.y,t.y);return[{x:i,y:s},{x:n,y:s},{x:n,y:o},{x:i,y:o}]},rectCoordCompare:function(e,t){return{upperX:rect}},isRectContain:function(e,t){return e[0].x<=t[0].x&&e[0].y<=t[0].y&&e[1].x>=t[1].x&&e[1].y>=t[1].y},isRectPureIntersect:function(e,t){var i=this.isRectContain(e,t)||this.isRectContain(t,e);return!this.isRectNotIntersect(e,t)&&!i},isRectIntersect:function(e,t){return!this.isRectNotIntersect(e,t)},isRectNotIntersect:function(e,t){return e[0].x>t[1].x||e[0].y>t[1].y||t[0].x>e[1].x||t[0].y>e[1].y},direction:{rightUp:1,leftUp:2,leftDown:3,rightDown:4},getPointDirection:function(e,t){return e.x>t.x&&e.y>=t.y?this.direction.rightDown:e.x<t.x&&e.y<=t.y?this.direction.leftUp:e.x>=t.x&&e.y<t.y?this.direction.rightUp:e.x<t.x&&e.y>=t.y?this.direction.leftDown:void 0},getScaleOffset:function(e,t,i){var s={x:i.x-t.x,y:i.y-t.y};return 1==e?(s.x=-s.x,s.y=-s.y):2==e?s.y=-s.y:4==e&&(s.x=-s.x),s}}}),define("color-picker",["jquery","utils"],function(e,t){var i={formatColor:function(e){return e<=0?e=0:e>=255&&(e=255),e=e.toString(16),e.length<=1&&(e="0"+e),e},initColor:function(){var e=this,t=parseInt("ff",16),i=parseInt("00",16),s=12,n={whiteBack:[],all:[]},o=0,r="";o=Math.floor(t/(s-1));for(var a=0;a<s;a++)r=a==s-1?this.formatColor(i):this.formatColor(t-a*o),n.whiteBack.push(r+r+r);s=9,colorList=["ff,00,00","ff,88,00","ff,ff,00","88,ff,00","00,ff,00","00,ff,88","00,ff,ff","00,88,ff","00,00,ff","88,00,ff","ff,00,ff","ff,00,88"],o=parseInt("33",16);for(var a=1;a<=s;a++)colorList.forEach(function(t){t=t.split(","),r="",o=parseInt("33",16)*(Math.ceil(s/2)-a),t.forEach(function(t){var i=parseInt(t,16);r+=255==i||0==i?e.formatColor(i+o):e.formatColor(i+parseInt(o/2))}),n.all.push(r)});return n},createDom:function(t){for(var i="",s="",n="",o=0,r=t.whiteBack.length;o<r;o++)i+="<li class='color-"+t.whiteBack[o]+"' style='background: #"+t.whiteBack[o]+";' data-color='"+t.whiteBack[o]+"'></li>";for(var o=0,r=t.all.length;o<r;o++)s+="<li class='color-"+t.all[o]+"' style='background: #"+t.all[o]+";' data-color='"+t.all[o]+"'></li>";n='<div class="common-popup-block color-picker">                            <ul>'+i+'</ul>                            <ul class="recommend-color">'+s+'</ul>                            <div class="color-info">                                <label for="color">#</label>                                <input id="color" type="text" value="" maxlength="6" />                                <span class="selected-color"></span>                            </div>                        </div>',e("body").append(n)},markSelecteColor:function(t){var i=e(".color-picker");i.find(".color-"+t).addClass("selected"),i.find("#color").val(t),i.find(".selected-color").css("background","#"+t)},setPopupPos:function(t){var i=t.offset(),s=t.height(),n=e(".color-picker"),o=5;n.css({left:i.left+"px",top:i.top+s+o+"px"})},clean:function(){var t=e(".color-picker");t.remove(),this.color="",this.triggerType="",e(document).off("click",this.bindBodyClickEvent)},setEvent:function(t){var i=this,s=e(".color-picker");s.find("li").hover(function(){var t=e(this),i=t.attr("data-color");s.find("#color").val(i),s.find(".selected-color").css("background","#"+i)},function(){s.find("#color").val(i.color),s.find(".selected-color").css("background","#"+i.color)}),s.find("#color").on("input",function(){var t=e(this);s.find(".selected-color").css("background","#"+t.val())}),s.find(".selected-color, li").on("click",function(){var e=s.find("#color").val();t(e),i.clean()}),e(document).on("click",i.bindBodyClickEvent)},bindBodyClickEvent:function(t){var s=e(t.target);"triggerByTarget"==i.triggerType||s.hasClass("color-picker")||s.parents(".color-picker").length||i.clean(),i.triggerType=""},init:function(e,t,i,s){this.clean(),this.color=t,this.triggerType=s;var n=this.initColor();this.createDom(n),this.setPopupPos(e),this.markSelecteColor(t),this.setEvent(i)}};return i}),define("popup-menu",["jquery","utils"],function(e,t){var i={name:"menu-popup",selector:".menu-popup",createDom:function(t){for(var i,s="",n="",o=t.type||"",r=0,a=t.menus.length;r<a;r++)i=t.menus[r],s+="separator"==i.type?'<li class="separator"></li>':'<li class="'+(i.operate||"")+" "+(i.status||"")+'" data-text="'+(i.text||"")+'" data-operate="'+(i.operate||"")+'" data-value="'+(i.value||"")+'"><i></i><span class="text">'+(i.text||"")+'</span><span class="shortcut">'+(i.shortcut||"")+"</span></li>";n='<div class="common-popup-block menu-popup '+o+'">                        <ul>'+s+"</ul>                    </div>",e("body").append(n)},setPopupPos:function(t){var i=e(this.selector),s=e(window).scrollLeft(),n=e(window).scrollTop();if(t instanceof e){var o=t.offset(),r=t.height(),a=5;i.css({left:o.left+"px",top:o.top+r+a+"px"})}else"contextmenu"==t.type?i.css({left:t.clientX+s+"px",top:t.clientY+n+"px"}):i.css({left:t.x+s+"px",top:t.y+n+"px"})},clean:function(){var t=e(this.selector);t.remove(),this.triggerType="",e(document).off("click",this.bindBodyClickEvent)},setEvent:function(t){var i=this,s=e(this.selector);s.find("li").click(function(){var s=e(this),n=s.attr("data-operate"),o=s.attr("data-text"),r=s.attr("data-value");s.hasClass("disabled")||s.hasClass("separator")||(t({operate:n,value:r,text:o}),i.clean())}),e(document).on("click",i.bindBodyClickEvent)},bindBodyClickEvent:function(t){var s=e(t.target);"triggerByTarget"==i.triggerType||s.hasClass(i.name)||s.parents(i.selector).length||i.clean(),i.triggerType=""},init:function(e,t,i,s){this.clean(),this.triggerType=s,this.createDom(t),this.setPopupPos(e),this.setEvent(i)}};return i}),define("text-input",["jquery","utils"],function(e,t){var i={padding:{top:2,left:4},name:"text-input-popup",selector:".text-input-popup",createDom:function(i){var s='<div class="text-input-popup">                            <p class="text-input" contenteditable="true">'+t.encodeHtmlAndAttr(i.text||"")+"</p>                        </div>";e("body").append(s);var n=e(this.selector).find(".text-input"),o=document.createRange(),r=window.getSelection();o.selectNodeContents(n[0]),r.removeAllRanges(),r.addRange(o)},setPopupPos:function(t){var i=e(this.selector);i.css({left:t.x-1+"px",top:t.y-1+"px"}),i.find(".text-input").css({padding:this.padding.top+"px "+this.padding.left+"px","min-height":t.height-2*this.padding.top,"min-width":t.width-2*this.padding.left})},clean:function(){var t=e(this.selector);t.remove(),this.triggerType="",e(document).off("click",this.bindBodyClickEvent)},setEvent:function(t){function i(i){if("keydown"!=i.type||13==i.keyCode){var n=e(i.target),o=n.text();t({text:o,width:n.width()+2*s.padding.left,height:n.height()+2*s.padding.top}),s.clean()}}var s=this,n=e(this.selector);n.find(".text-input").keydown(i),n.find(".text-input").blur(i),e(document).on("click",s.bindBodyClickEvent)},bindBodyClickEvent:function(t){var s=e(t.target);"triggerByTarget"==i.triggerType||s.hasClass(i.name)||s.parents(i.selector).length||i.clean(),i.triggerType=""},init:function(e,t,i,s){this.clean(),this.triggerType=s,this.createDom(t),this.setPopupPos(e),this.setEvent(i)}};return i}),define("common",["layer","utils","color-picker","popup-menu","text-input"],function(e,t,i,s,n){return{layer:e,utils:t,colorPicker:i,popupMenu:s,textInput:n}}),define("templates/attr-tpl",[],function(){var e='<% if (attrCategories.length) { %>                    <ul>                        <% _.each(attrCategories, function(category){ %>                            <li class="attrs <%= category.name %>">                                <ul>                                    <% _.each(category.attrs, function(attr){ %>                                        <% if((["fontSize", "textColor"]).indexOf(attr.name) != -1){ %>                                            <li class="separator"></li>                                        <% } %>                                        <li class="<%= attr.className %>" title="<%= attr.text %>" data-attr="<%= attr.name %>">                                            <% if (attr.name == "scale") { %>                                                <p class="text-input"><i>页面比例: </i><input type="text" value="<%= attr.value %>%" maxlength="4"></p>                                            <% } else if (attr.name == "font") { %>                                                <p class="text-show"><%= attr.value %></p>                                            <% } else if (attr.name == "fontSize") { %>                                                <p class="text-input"><input type="text" value="<%= attr.value %>" maxlength="2"><i>px</i></p>                                                <div class="resize-font-size">                                                    <span class="big-font-size"></span>                                                    <span class="small-font-size"></span>                                                </div>                                            <% } else if (attr.name == "pos") { %>                                                <p>                                                    <span>X: <i class="left">123</i>px</span>                                                    <span>Y: <i class="top">456</i>px</span>                                                </p>                                            <% } else if (attr.name == "size") { %>                                                <p>                                                    <span>W: <i class="width">123</i>px</span>                                                    <span>H: <i class="height">456</i>px</span>                                                </p>                                            <% } else { %>                                                <% if (attr.className.indexOf("has-value")) { %>                                                    <p class="bg-icon" style="border-bottom-color: #<%= attr.value %>;"></p>                                                <% } else { %>                                                    <p class="bg-icon"></p>                                                <% } %>                                            <% } %>                                        </li>                                    <% }) %>                                </ul>                            </li>                        <% }) %>                    </ul>                <% } %>';return e}),define("attrs",["jquery","underscore","backbone","svg","templates/attr-tpl","common"],function(e,t,i,s,n,o){var r=i.Model.extend({defaults:function(){return{undo:{className:"undo",value:"",available:!1,text:"撤销"},redo:{value:"",className:"redo",available:!1,text:"恢复"},formatBrush:{className:"format-brush",value:"",available:!1,text:"格式刷"},scale:{className:"scale",value:0,default:100,available:!0,list:[200,150,125,110,100,90,75,50,25],text:"缩放"},font:{className:"font-family",value:"",default:"Microsoft Yahei",list:["Helvetica Neue","Helvetica","Arial","PingFang SC","Hiragino Sans GB","WenQuanYi Micro Hei","Microsoft Yahei","sans-serif"],available:!1,text:"字体"},fontSize:{className:"font-size",value:0,default:14,available:!1,text:"字体大小",max:72,min:10},textColor:{className:"color",value:"",default:"333",available:!1,text:"字体颜色"},textBold:{className:"bold",value:"",available:!1,text:"加粗"},textItalic:{className:"italic",value:"",available:!1,text:"斜体"},arrange:{value:"",list:[{value:"arrange-left",text:"左对齐"},{value:"arrange-right",text:"右对齐"},{value:"arrange-top",text:"顶对齐"},{value:"arrange-bottom",text:"底对齐"},{value:"arrange-center",text:"水平居中"},{value:"arrange-middle",text:"垂直居中"},{value:"arrange-center-middle",text:"水平垂直居中"},{value:"arrange-h",text:"水平分布"},{value:"arrange-v",text:"垂直分布"}],className:"arrange-left",default:"arrange-left",available:!1,text:"对齐"},fillColor:{className:"fill-color",value:"",default:"fff",available:!1,text:"填充色"},borderColor:{className:"stroke-color",value:"",default:"666",available:!1,text:"边框色"},borderStyle:{className:"border-style",value:"",default:"solid",list:[{value:"solid",text:""},{value:"dashed",text:""},{value:"dot",text:""}],available:!1,text:"边框类型"},borderWidth:{className:"border-width",value:"",list:[1,2,3,4,5,6,8,10],default:1,available:!1,text:"边框宽度"},startArrow:{className:"line-start",value:"",list:[{value:"line-no-arrow",text:"直线"},{value:"line-with-arrow",text:"实心箭头"}],default:"line-no-arrow",available:!1,text:"起点类型"},endArrow:{className:"line-end",default:"line-with-arrow",value:"",list:[{value:"line-no-arrow",text:"直线"},{value:"line-with-arrow",text:"实心箭头"}],available:!1,text:"终点类型"},moveUp:{className:"move-up",value:"",available:!1,text:"上移一层"},moveDown:{className:"move-down",value:"",available:!1,text:"下移一层"},copy:{className:"copy",value:"",available:!1,text:"复制"},cut:{className:"cut",value:"",available:!1,text:"剪切"},paste:{className:"paste",value:"",available:!1,text:"粘贴"},delete:{className:"delete",value:"",available:!1,text:"删除"},pos:{className:"offset",x:"",y:"",available:!1},size:{className:"size",h:"",w:"",available:!1},viewId:0}},sync:function(e,t,i){t.set("id",t.cid),i.success({})}}),a=i.View.extend({commonAttrs:["redo","undo","formatBrush","scale","moveUp","moveDown","copy","cut","paste","delete","pos","size"],selectedAttrs:["formatBrush","moveUp","moveDown","copy","cut","delete"],svgElemDisabledAttrs:{line:["font","fontSize","textColor","textBold","textItalic","arrange","fillColor","size"],rect:["startArrow","endArrow"],device:["fillColor","borderColor","borderStyle","borderWidth","startArrow","endArrow"]},categories:[{name:"recovery",attrs:["undo","redo","formatBrush","scale"]},{name:"font",attrs:["font","fontSize","textColor","textBold","textItalic","arrange"]},{name:"format",attrs:["fillColor","borderColor","borderWidth","borderStyle","startArrow","endArrow"]},{name:"cascade",attrs:["moveUp","moveDown"]},{name:"copy-paste",attrs:["copy","paste","cut","delete"]},{name:"pos",attrs:["pos","size"]}],tagName:"div",className:"top-attrs",initialize:function(){this.listenTo(this.model,"sync",this.render),this.on({showTypeAttr:this.showTypeAttr},this)},template:t.template(n),getAttrClassName:function(e,t){var i=[];if("undefined"==typeof t){var s=this.model.toJSON();t=s[e]}return t&&(i.push(t.available?"enable":"disabled"),t.list&&i.push("with-arrow"),["textColor","fillColor","borderColor"].indexOf(e)!=-1&&i.push("has-value with-arrow"),"fontSize"==e?i.push("no-padding"):"startArrow"!=e&&"endArrow"!=e||i.push(t.value||t.default),i.push(t.className)),i.join(" ")},formatData:function(){var e=this,t=this.model.toJSON(),i=[];return this.categories.forEach(function(s){var n={name:s.name,attrs:[]};s.attrs.forEach(function(i){var s=t[i],o=null;s&&(o={text:s.text,name:i,value:s.value||s.default,className:e.getAttrClassName(i,s)},n.attrs.push(o))}),n.attrs.length&&i.push(n)}),{attrCategories:i}},render:function(){return this.$el.html(this.template(this.formatData())),this},events:{"click .attrs li":"showAttrItems","keydown .scale input":"manualSetScale","focus .scale input":"manualSetScale","click .font-size span":"modifyFontSize","keydown .font-size input":"manualSetFontSize","focus .font-size input":"manualSetFontSize"},showTypeAttr:function(e){var i=this;if(e=e||{},!Array.isArray(e.types)||!e.types.length)return void this.model.save(this.model.defaults());var i=this,s=[],n=this.model.toJSON();e.types.forEach(function(e,n){var o=i.svgElemDisabledAttrs[e]||[];s=0!=n?t.intersection(s,o):o}),t.each(n,function(e,t){s.indexOf(t)!=-1?(e.available=!1,e.value=""):i.selectedAttrs.indexOf(t)!=-1?e.available=!0:i.commonAttrs.indexOf(t)==-1&&(e.available=!0)}),this.model.save(n)},setAttr:function(e){var t=this.model.get(e.name),s={},n=e.value;e.check&&(n=this[e.check](e.value)),t.value=n,s[e.name]=t,this.model.save(t),i.trigger("set"+e.name[0].toUpperCase()+e.name.slice(1),{value:n})},getProperFontSizeValue:function(e){var t=this.model.get("fontSize"),e=parseInt(e,10);return e?e<t.min?e=t.min:e>t.max&&(e=t.max):e=t.default,e},manualSetFontSize:function(e){if("focus"==e.type||"focusin"==e.type)e.target.select();else if(13==e.keyCode){var t=e.target.value;this.setAttr({name:"fontSize",value:t,check:"getProperFontSizeValue"}),e.target.blur()}},modifyFontSize:function(t){var i=this.model.get("fontSize"),s=e(t.target),n=i.value||i.default;s.hasClass("big-font-size")?n+=1:n-=1,this.setAttr({name:"fontSize",value:n,check:"getProperFontSizeValue"})},getProperScaleValue:function(e){var t=this.model.get("scale"),e=parseInt(e);return e||(e=t.default),e>t.list[0]?e=t.list[0]:e<t.list[t.list.length-1]&&(e=t.list[t.list.length-1]),e},manualSetScale:function(e){if("focus"==e.type||"focusin"==e.type)e.target.select();else if(13==e.keyCode){var t=e.target.value;this.setAttr({name:"scale",value:t,check:"getProperScaleValue"}),e.target.blur()}},showScaleItems:function(e){var t=this,i=this.model.get("scale"),s={type:"with-selected no-icon",menus:[]};i.list.forEach(function(e){var t=!1,n=i.value||i.default;e==n&&(t=!0),s.menus.push({operate:"setScale",status:t?"selected":"",value:e,text:e+"%",shortcut:""})}),o.popupMenu.init(e,s,function(e){t.setAttr({name:"scale",value:e.value,check:"getProperScaleValue"})},"triggerByTarget")},showFontItems:function(e){var t=this,i=this.model.get("font"),s={type:"with-selected no-icon",menus:[]};i.list.forEach(function(e){var t=!1,n=i.value||i.default;e==n&&(t=!0),s.menus.push({operate:"setFont",status:t?"selected":"",value:e,text:e,shortcut:""})}),o.popupMenu.init(e,s,function(e){t.setAttr({name:"font",value:e.value})},"triggerByTarget")},showColorItems:function(e,t){var i=this,s=this.model.get(t),n=s.value||s.default;o.colorPicker.init(e,n,function(e){i.setAttr({name:t,value:e})},"triggerByTarget")},showLineArrowItems:function(e,t){var i=this,s=this.model.get(t),n={type:"with-selected "+s.className,menus:[]};s.list.forEach(function(e){var t=!1,i=s.value||s.default;e.value==i&&(t=!0),n.menus.push({operate:e.value,status:t?"selected":"",value:e.value,text:e.text,shortcut:""})}),o.popupMenu.init(e,n,function(e){i.setAttr({name:t,value:e.value})},"triggerByTarget")},showBorderWidthItems:function(e){var t=this,i=this.model.get("borderWidth"),s={type:"with-selected no-icon",menus:[]};i.list.forEach(function(e){var t=!1,n=i.value||i.default;e==n&&(t=!0),s.menus.push({operate:"setBorderWidth",status:t?"selected":"",value:e,text:e+"px",shortcut:""})}),o.popupMenu.init(e,s,function(e){t.setAttr({name:"borderWidth",value:e.value})},"triggerByTarget")},showBorderStyleItems:function(e){var t=this,i=this.model.get("borderStyle"),s={type:"with-selected no-icon set-border-style",menus:[]};i.list.forEach(function(e){var t=!1,n=i.value||i.default;e.value==n&&(t=!0),s.menus.push({operate:"setBorderStyle",status:t?"selected":"",value:e.value,text:e.text,shortcut:""})}),o.popupMenu.init(e,s,function(e){t.setAttr({name:"borderStyle",value:e.value})},"triggerByTarget")},showArrangeItems:function(e){var t=this,i=this.model.get("arrange"),s={type:"with-selected no-icon",menus:[]};i.list.forEach(function(e){var t=!1,n=i.value||i.default;e.value==n&&(t=!0),s.menus.push({operate:"setArrange",status:t?"selected":"",value:e.value,text:e.text,shortcut:""})}),o.popupMenu.init(e,s,function(e){t.setAttr({name:"arrange",value:e.value})},"triggerByTarget")},showAttrItems:function(t){var i=e(t.currentTarget),s=i.attr("data-attr");i.hasClass("disabled")||("scale"==s?"INPUT"!=t.target.nodeName&&this.showScaleItems(i):"font"==s?this.showFontItems(i):["textColor","fillColor","borderColor"].indexOf(s)!=-1?this.showColorItems(i,s):"startArrow"==s||"endArrow"==s?this.showLineArrowItems(i,s):"borderStyle"==s?this.showBorderStyleItems(i):"borderWidth"==s?this.showBorderWidthItems(i):"arrange"==s&&this.showArrangeItems(i))}});return{view:a,model:r}}),define("templates/tool-tpl",[],function(){var e='<% if (tools.length) { %>                    <ul>                        <% _.each(tools, function(item){ %>                            <li class="<%- item.type %>" draggable="false" data-type="<%- item.type %>">                                <p title="<%- item.name %>"></p>                            </li>                        <% }); %>                    </ul>                <% } %>';return e}),define("tools",["jquery","underscore","backbone","svg","templates/tool-tpl"],function(e,t,i,s,n){var o=i.Model.extend({defaults:{tools:[]}}),r=i.View.extend({preventBodyClear:!1,type:"tool",tagName:"div",className:"left-tools",initialize:function(e){this.model.set({tools:e.tools}),this.on({selectDone:this.clearItemSelected,setSelected:this.selectTool},this)},template:t.template(n),render:function(){return this.$el.html(this.template(this.model.toJSON())),this},selectTool:function(t){var i=e(t.event.target),s="";if(i.parents("li").length)i=i.parents("li");else if("li"!=i[0].tagName)return;s=i.attr("data-type"),this.clearItemSelected(),i.addClass("selected"),this.trigger("selectTool",{type:this.type,value:s})},clearItemSelected:function(){var e=this.$el.find("li");e.removeClass("selected")},getSelected:function(){return this.$el.find("li.selected")}});return{view:r,model:o}}),define("templates/device-tpl",[],function(){var e='<% if (devices.length) { %>                    <ul>                        <% _.each(devices, function(item){ %>                            <li draggable="false" data-type="<%- item.type %>">                                <img draggable="false" src="<%= item.src %>">                                <p><%- item.name %></p>                            </li>                        <% }); %>                    </ul>                <% } %>';return e}),define("devices",["jquery","underscore","backbone","svg","templates/device-tpl","common"],function(e,t,i,s,n,o){var r=i.Model.extend({defaults:{devices:[]}}),a=i.View.extend({preventBodyClear:!1,type:"device",tagName:"div",className:"bottom-icons",initialize:function(e){this.model.set({devices:e.devices}),this.on({selectDone:this.clearItemSelected,setSelected:this.selectDevice},this),this.listenTo(i,"showDeviceIdList",this.showDeviceIdList),this.listenTo(i,"updateDeviceIdStatus",this.updateDeviceIdStatus)},template:t.template(n),render:function(){return this.$el.html(this.template(this.model.toJSON())),this},selectDevice:function(t){var i=e(t.event.target),s="";if(i.parents("li").length)i=i.parents("li");else if("li"!=i[0].tagName)return;s=i.attr("data-type"),i.hasClass("selected")||(this.clearItemSelected(),i.addClass("selected"),this.trigger("selectDevice",{type:this.type,value:s}))},clearItemSelected:function(){var e=this.$el.find("li");e.removeClass("selected")},getSelected:function(){return this.$el.find("li.selected")},getAvailableList:function(e){for(var t=this.model.get("devices"),i=[],s=[],n=0,o=t.length;n<o;n++)t[n].type==e&&(i=t[n].devices);for(var n=0,o=i.length;n<o;n++)i[n].available&&s.push(i[n]);return s},setDeviceIdStatus:function(e,t,i){for(var s=this.model.get("devices"),n=[],o=0,r=s.length;o<r;o++)s[o].type==e&&(n=s[o].devices);for(var o=0,r=n.length;o<r;o++)n[o].id==t&&(n[o].available=i);this.model.set("devices",s)},updateDeviceIdStatus:function(e){this.setDeviceIdStatus(e.type,e.id,e.status)},showDeviceIdList:function(e){var t=this.getAvailableList(e.type),s=[],n=this;if(!t.length)return void o.layer.topNotify("error",{content:"该类设备下已经没有设备可以绑定",shade:!1,time:2});for(var r=0,a=t.length;r<a;r++)s.push({operate:"setId",value:t[r].id,text:t[r].name});o.popupMenu.init(e.pos,{menus:s},function(t){n.setDeviceIdStatus(e.type,t.value,!1),i.trigger(t.operate,{deviceId:t.value,deviceName:t.text,viewId:e.id})})}});return{view:a,model:r}}),define("view",["jquery","underscore","backbone","svg","common"],function(e,t,i,s,n){var o=i.View.extend({domToSvgPos:function(t){var i=this.getSvgRoot(),s=this.getMainContainerElem(),n=e(i.node).offset(),o=e(window).scrollTop(),r=e(window).scrollLeft(),a=s.scrollTop()+o,l=s.scrollLeft()+r;return{x:t.x-n.left+l,y:t.y-n.top+a}},getSvgRoot:function(e){return this.svg.doc()},getMainContainerElem:function(){return e(this.svg.node).parents(".draw-container")},getMousePos:function(e){var t=e.clientX,i=e.clientY;return this.domToSvgPos({x:t,y:i})}}),r=o.extend({initialize:function(e){this.baseSvg=e.svg,this.svg=null,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.id=e.viewId||0,this.listenTo(i,"setFont",this.setFont),this.listenTo(i,"setFontSize",this.setFontSize),this.listenTo(i,"setTextColor",this.setTextColor),this.listenTo(i,"setFillColor",this.setFillColor),this.listenTo(i,"setBorderColor",this.setBorderColor),this.listenTo(i,"setBorderWidth",this.setBorderWidth),this.listenTo(i,"setBorderStyle",this.setBorderStyle),this.listenTo(i,"setStartArrow",this.setLinePoint),this.listenTo(i,"setEndArrow",this.setLinePoint),this.listenTo(i,"setArrange",this.setArrange),this.on({setSelected:this.selectedView,removeSelected:this.removeSelected},this),this.init(e)},init:function(){},setSvgText:function(e,t){for(var i={top:2,left:4},s=t.bbox().width,n=t.text(""),o=null,r=[],a="",l="",c=0,d=0,u=e.length;d<u;d++)l=a,a+=e[d],n.tspan(a),o=n.bbox(),o.width+2*i.left>s&&(r.push({text:l,dy:c}),c=o.height,a=e[d],n.tspan(a));return a&&r.push({text:a,dy:c}),n.remove(),n=t.text(function(e){r.forEach(function(t){e.tspan(t.text).newLine()})})},getDefaultStyle:function(){},getCurrentStyle:function(){},setStyle:function(){},setFont:function(e){n.layer.topNotify("info",{content:"set font "+e.value,shade:!1,time:2})},setFontSize:function(e){n.layer.topNotify("info",{content:"set font size"+e.value+"px",shade:!1,time:2})},setTextColor:function(e){n.layer.topNotify("info",{content:"set text color #"+e.value,shade:!1,time:2})},setFillColor:function(e){n.layer.topNotify("info",{content:"set fill color #"+e.value,shade:!1,time:2})},setBorderColor:function(e){n.layer.topNotify("info",{content:"set border color #"+e.value,shade:!1,time:2})},setLinePoint:function(e){n.layer.topNotify("info",{content:"set line point "+e.value,shade:!1,time:2})},setBorderWidth:function(e){n.layer.topNotify("info",{content:"set border width"+e.value,shade:!1,time:2})},setBorderStyle:function(e){n.layer.topNotify("info",{content:"set border style "+e.value,shade:!1,time:2})},setArrange:function(e){n.layer.topNotify("info",{content:"set arrange "+e.value,shade:!1,time:2})},createBorder:function(e,t){var i=0,s=6,n=e.bbox(),o=this.svg.group().addClass("svg-group-border"),r=[n,{cx:n.cx-n.width/2-i,cy:n.cy-n.height/2-i,width:s,height:s},{cx:n.cx+n.width/2+i,cy:n.cy-n.height/2-i,width:s,height:s},{cx:n.cx+n.width/2+i,cy:n.cy+n.height/2+i,width:s,height:s},{cx:n.cx-n.width/2-i,cy:n.cy+n.height/2+i,width:s,height:s}],a=null;t||o.addClass("dsn"),o.back(),this.borderGroup=o;for(var l=0,c=r.length;l<c;l++)n=r[l],a=o.path("M "+(n.cx-n.width/2)+" "+(n.cy-n.height/2)+"L "+(n.cx+n.width/2)+" "+(n.cy-n.height/2)+"L "+(n.cx+n.width/2)+" "+(n.cy+n.height/2)+"L "+(n.cx-n.width/2)+" "+(n.cy+n.height/2)+"Z"),a.stroke({color:"#60f"}).fill("#fff"),0!=l&&(a.addClass("svg-border-corner").attr("data-order",l),l%2==1?a.addClass("svg-border-corner svg-cursor-nwse"):a.addClass("svg-border-corner svg-cursor-nesw"))},createConnectPoints:function(e,t){var i=0,s=6,n=e.bbox(),o=this.svg.group().addClass("svg-group-points"),r=[{cx:n.cx,cy:n.cy-n.height/2-i,width:s},{cx:n.cx+n.width/2+i,cy:n.cy,width:s},{cx:n.cx,cy:n.cy+n.height/2+i,width:s},{cx:n.cx-n.width/2-i,cy:n.cy,width:s}],a=null;t||o.addClass("dsn"),this.pointGroup=o;for(var l=0,c=r.length;l<c;l++)n=r[l],a=o.circle(n.width).center(n.cx,n.cy),a.fill("#999")},setPointGroupStatus:function(e){this.pointGroup&&(e?this.pointGroup.removeClass("dsn"):this.pointGroup.addClass("dsn"))},setBorderGroupStatus:function(e){this.borderGroup&&(e?this.borderGroup.removeClass("dsn"):this.borderGroup.addClass("dsn"))},removeSelected:function(){this.setBorderGroupStatus(!1),this.isSelected=!1},selectedView:function(){this.setBorderGroupStatus(!0),this.isSelected=!0},moveView:function(e){var t=this.svg.transform();this.svg.transform({x:t.x+e.x,y:t.y+e.y})},moveEnd:function(){var e=this.svg.transform();this.model.set({offset:e})},resizeView:function(e){this.model.set({width:e.width,height:e.height,centerX:e.centerX,centerY:e.centerY})}}),a=r.extend({tagName:"g",className:"svg-line",type:"line",defaultStyle:{strokeColor:"#333"},defaultSize:{width:100,height:60},init:function(){this.svg=(new s.G).addClass(this.className),this.lineGroup=null,this.borderGroup=null,this.pointGroup=null,this.isSelected=!1,this.setElement(this.svg.node),this.on({move:this.moveView,moveEnd:this.moveEnd,
resize:this.resizeView},this)},events:{},resizeView:function(e){this.model.set({width:e.width,height:e.height,centerX:e.centerX,centerY:e.centerY})},createBorder:function(e){var t=this.getMovePoints();corderWidth=4,group=this.svg.group().addClass("svg-group-border"),centerPoints=[{cx:t.start.x,cy:t.start.y,width:corderWidth,height:corderWidth},{cx:t.end.x,cy:t.end.y,width:corderWidth,height:corderWidth}],path=null,t.mid&&centerPoints.push({cx:t.mid.x,cy:t.mid.y,width:corderWidth,height:corderWidth}),e||group.addClass("dsn"),this.borderGroup=group;for(var i=0,s=centerPoints.length;i<s;i++)box=centerPoints[i],path=group.path("M "+(box.cx-box.width/2)+" "+(box.cy-box.height/2)+"L "+(box.cx+box.width/2)+" "+(box.cy-box.height/2)+"L "+(box.cx+box.width/2)+" "+(box.cy+box.height/2)+"L "+(box.cx-box.width/2)+" "+(box.cy+box.height/2)+"Z"),path.stroke({color:"#60f"}).fill("#fff").addClass("svg-border-corner svg-cursor-nesw"),0==i&&path.removeClass("svg-cursor-nesw").addClass("svg-cursor-nwse"),2==i&&path.removeClass("svg-cursor-nesw").addClass("svg-cursor-ew")},getSize:function(){return{width:this.model.get("width")||this.defaultSize.width,height:this.model.get("height")||this.defaultSize.height}},getLineDefaultPoints:function(){var e=this.model.toJSON(),t=this.getSize();return{start:{x:parseInt(e.centerX-t.width/2),y:parseInt(e.centerY)},end:{x:parseInt(e.centerX+t.width/2),y:parseInt(e.centerY)}}},getPolylineDefaultPoints:function(){var e=this.model.toJSON(),t=this.getSize();return{start:{x:parseInt(e.centerX-t.width/2),y:parseInt(e.centerY-t.height/2)},point1:{x:parseInt(e.centerX),y:parseInt(e.centerY-t.height/2)},point2:{x:parseInt(e.centerX),y:parseInt(e.centerY+t.height/2)},end:{x:parseInt(e.centerX+t.width/2),y:parseInt(e.centerY+t.height/2)}}},getPoints:function(){var e=this.model.toJSON();return e.points.length?e.points:"line"==e.value?this.getLineDefaultPoints():this.getPolylineDefaultPoints()},getEndPoints:function(){var e=this.getPoints();return{start:e.start,end:e.end}},getMidPoints:function(){var e=this.getPoints();return e.point1||e.point2?{point1:e.point1,point2:e.point2}:null},getMovePoints:function(){var e=this.model.toJSON();return points=this.getEndPoints(),"line"==e.value?points:t.extend({mid:{x:e.centerX,y:e.centerY}},points)},create:function(e,t){var i=this.svg.group().addClass("svg-line-group"),s="",n=this.getPoints();s=n.point1?"M "+n.start.x+" "+n.start.y+" L "+n.point1.x+" "+n.point1.y+" L "+n.point2.x+" "+n.point2.y+" L "+n.end.x+" "+n.end.y:"M "+n.start.x+" "+n.start.y+" L "+n.end.x+" "+n.end.y,i.path(s).attr({stroke:"transparent","stroke-width":5,fill:"transparent"}),i.path(s).attr({stroke:this.defaultStyle.strokeColor,fill:"transparent"})},render:function(){var e=this.model.toJSON();return this.svg.clear(),e.offset&&this.svg.transform(e.offset),this.create({x:e.centerX,y:e.centerY},e.value),this.createBorder(this.isSelected),this}}),l=r.extend({tagName:"g",className:"svg-rect",type:"rect",defaultStyle:{fill:"#fff",strokeColor:"#333",fontSize:12,color:"#666"},defaultSize:{width:100,height:60,radius:4},init:function(){this.svg=(new s.G).addClass(this.className),this.borderGroup=null,this.rectGroup=null,this.pointGroup=null,this.isSelected=!1,this.setElement(this.svg.node),this.on({move:this.moveView,moveEnd:this.moveEnd,resize:this.resizeView},this)},events:{dblclick:"showTextEdit"},showTextEdit:function(e){var t=this.svg.rbox(),i={x:t.x,y:t.y,width:t.width,height:t.height},s=this;n.textInput.init(i,{text:this.model.get("text")},function(e){s.model.set({text:e.text,width:e.width,height:e.height})},"triggerByTarget")},create:function(e,t,i){var s=this.svg.group().addClass("svg-rect-group"),n=null,o=this.model.get("width")||this.defaultSize.width,r=this.model.get("height")||this.defaultSize.height;this.rectGroup=s,n=s.rect(o,r),n.attr({x:e.x-o/2,y:e.y-r/2,fill:this.defaultStyle.fill,stroke:this.defaultStyle.strokeColor}),"round-rect"==t&&n.radius(this.defaultSize.radius),i&&(i=this.setSvgText(i,s).addClass("svg-rect-text").attr({fill:this.defaultStyle.color}).leading(1),i.center(e.x,e.y))},render:function(){var e=this.model.toJSON();return this.svg.clear(),e.offset&&this.svg.transform(e.offset),this.create({x:e.centerX,y:e.centerY},e.value,e.text),this.createConnectPoints(this.rectGroup,this.isShowPoints),this.createBorder(this.rectGroup,this.isSelected),this}}),c=r.extend({tagName:"g",className:"svg-device",type:"device",defaultStyle:{font:"Helvetica",fontSize:12,color:"#666"},iconPadding:10,defaultSize:{width:60,height:60},init:function(){this.svg=(new s.G).addClass(this.className),this.deviceGroup=null,this.borderGroup=null,this.pointGroup=null,this.isSelected=!1,this.setElement(this.svg.node),this.on({move:this.moveView,moveEnd:this.moveEnd,resize:this.resizeView},this),this.listenTo(this.model,"change:deviceId",this.updateDeviceId),this.listenTo(i,"setId",this.setDeviceId)},events:{dblclick:"showDeviceIdList"},updateDeviceId:function(e,t){var s=e.previous("deviceId");s&&s!=t&&i.trigger("updateDeviceIdStatus",{type:this.model.get("value"),id:s,status:!0})},setDeviceId:function(e){e.viewId==this.id&&this.model.set({deviceId:e.deviceId,deviceName:e.deviceName})},showDeviceIdList:function(e){i.trigger("showDeviceIdList",{type:this.model.get("value"),pos:{x:e.clientX,y:e.clientY},id:this.id})},getImgUrl:function(e){return"/imgs/"+e+".svg"},create:function(e,t,i){var s=this.svg.group().addClass("svg-device-group"),n=null,o=null,r=null,a=this.model.get("width")||this.defaultSize.width,l=this.model.get("height")||this.defaultSize.height;i=i||"设置设备",o=s.text(""+i).addClass("svg-device-id").font({fill:this.defaultStyle.color,family:this.defaultStyle.font,size:this.defaultStyle.size}),r=o.rbox(),o.attr({x:e.x-r.width/2,y:e.y-l/2-r.height-this.iconPadding}),n=s.image(this.getImgUrl(t),a,l).attr({x:e.x-a/2,y:e.y-l/2}),this.deviceGroup=s},render:function(){var e=this.model.toJSON();return this.deviceGroup&&this.svg.clear(),e.offset&&this.svg.transform(e.offset),this.create({x:e.centerX,y:e.centerY},e.value,e.deviceName),this.createConnectPoints(this.deviceGroup,this.isShowPoints),this.createBorder(this.deviceGroup,this.isSelected),this}});return{base:o,line:a,rect:l,device:c}}),define("model",["jquery","underscore","backbone","svg"],function(e,t,i,s){var n=i.Model.extend({defaults:function(){return{id:0,x:0,y:0,centerX:0,centerY:0,type:"",value:"",width:0,height:0,zIndex:0,points:[],offset:null,deviceId:"",deviceName:"",text:"",font:"",fontSize:0,fontStyle:"",borderWidth:0,borderStyle:"",strokeColor:"",fullColor:"",rotate:0,parentId:"",children:[]}},sync:function(e,t,i){"DELETE"!=e&&t.set("id",t.cid),i.success({})}}),o=n.extend({defaults:function(){var e=t.result(n.prototype,"defaults"),i={};return t.defaults(i,e)}}),r=n.extend({}),a=n.extend({});return{base:n,line:o,rect:r,device:a}}),define("collection",["jquery","underscore","backbone","svg","model"],function(e,t,i,s,n){var o=i.Collection.extend({initialize:function(){}}),r=o.extend({model:n.line}),a=o.extend({model:n.rect}),l=o.extend({model:n.device});return{base:o,line:r,rect:a,device:l}}),require.config({baseUrl:"js",paths:{jquery:"lib/jquery.min",underscore:"lib/underscore.min",backbone:"lib/backbone",svg:"lib/svg.min"}}),require(["jquery","underscore","backbone","svg","common","attrs","tools","devices","view","model","collection"],function(e,t,s,n,o,r,a,l,c,d,u){e(".color, .full-color, .stroke-color").click(function(){var t=e(this);o.colorPicker.init(t,"000000",function(e){o.layer.topNotify("info",{content:"颜色值: #"+e,shade:!1,time:2})},"triggerByTarget")});var h={type:"with-selected",menus:[{operate:"copy",status:"selected",value:"",text:"复制",shortcut:"ctrl+c"},{operate:"copy",status:"disabled",value:"",text:"复制",shortcut:"ctrl+c"},{type:"separator"},{operate:"cut",status:"",value:"cut",text:"剪切",shortcut:"ctrl+x"},{operate:"page",status:"",value:"paste",text:"粘贴",shortcut:"ctrl+v"}]},f={type:"",menus:[{operate:"copy",status:"selected",value:"",text:"复制",shortcut:"ctrl+c"},{operate:"copy",status:"disabled",value:"",text:"复制",shortcut:"ctrl+c"},{type:"separator"},{operate:"cut",status:"",value:"cut",text:"剪切",shortcut:"ctrl+x"},{operate:"page",status:"",value:"paste",text:"粘贴",shortcut:"ctrl+v"}]};e(".border-width, .border-style").click(function(t){var i=e(this);o.popupMenu.init(i,h,function(e,t){o.layer.topNotify("info",{content:"operate: "+e+"<br />value: "+t,shade:!1,time:2})},"triggerByTarget")});var v=c.base.extend({initialize:function(t){this.data=t,this.$main=e("<div></div>").addClass("draw-container"),this.$el.append(this.$main),this.svg=null,this.bg=null,this.selectTipsBox=null,this.deviceView=null,this.toolView=null,this.attrView=null,this.deviceCollections=new u.device,this.rectCollections=new u.rect,this.lineCollections=new u.line,this.elemToBeAdd=null,this.subViews={},this.itemToBeAdd={type:"",value:""},this.attrSelected={type:"",value:""},this.selectedViews=[],t.isEdit?(this.$main.addClass("can-edit"),this.initAttr(),this.render(t),this.initTool(t.tools),this.initDevice(t.devices),this.setRightBtnMenu()):this.render(t),this.setOtherEvents(),this.setBodyEvents()},getSelectedViewByTarget:function(t){var i="svg-view",s=e(t.target),n=0;return s.hasClass(i)?n=s.attr("data-id"):s.parents("."+i).length&&(s=s.parents("."+i),n=s.attr("data-id")),n?this.getSubView(n):null},isMoveOperate:function(t){var i="svg-group-border",s=e(t.target);return!s.hasClass(i)&&!s.parents("."+i).length},isClickOnEle:function(t,i){var s=e(t.target);return!(!s.hasClass(i)&&!s.parents("."+i).length)},isClickOnSvgView:function(e){return this.isClickOnEle(e,"svg-view")},isClickOnAttrEle:function(e){return this.isClickOnEle(e,"top-attrs")},isClickOnPopup:function(e){return this.isClickOnEle(e,"common-popup-block")},isClickOnDraw:function(e){return this.isClickOnEle(e,"draw-content")},isClickOnTool:function(e){return this.isClickOnEle(e,"left-tools")},isClickOnDevice:function(e){return this.isClickOnEle(e,"bottom-icons")},getClickAttr:function(e){},moveView:function(e){this.selectedViews.forEach(function(t){t.trigger("move",e)})},endMoveView:function(){this.selectedViews.forEach(function(e){e.trigger("moveEnd")})},setMoveEvents:function(){var t=this,i=!1;lastPos=null,e(document).mousedown(function(e){0==e.button&&t.isMoveOperate(e)&&(i=t.isClickOnSvgView(e),lastPos={x:e.clientX,y:e.clientY})}),e(document).mousemove(function(e){if(lastPos&&i){var s={x:e.clientX-lastPos.x,y:e.clientY-lastPos.y};lastPos={x:e.clientX,y:e.clientY},t.moveView(s)}}),e(document).click(function(e){lastPos&&i&&t.endMoveView(),lastPos=null,i=!1}),e(document).keydown(function(e){var i=e.key||e.keyCode,s={x:0,y:0};"ArrowUp"==i||38==i?s.y-=1:"ArrowDown"==i||40==i?s.y+=1:"ArrowLeft"==i||37==i?s.x-=1:"ArrowRight"!=i&&39!=i||(s.x+=1),t.moveView(s),t.endMoveView()})},setResizeEvents:function(){var t=this,i=null,s=null,n=null,r=null,a=0;e(document).mousedown(function(e){0!=e.button||t.isMoveOperate(e)||(i=t.getSelectedViewByTarget(e),r=i.model.get("points"),a=e.target.getAttribute("data-order")||0,n={width:i.model.get("width")||i.defaultSize.width,height:i.model.get("height")||i.defaultSize.height,centerX:i.model.get("centerX"),centerY:i.model.get("centerY")}),i&&n&&(s={x:e.clientX,y:e.clientY})}),e(document).mousemove(function(e){if(i&&s&&n){var t=i.model.get("value"),l=o.utils.getScaleOffset(parseInt(a),s,{x:e.clientX,y:e.clientY}),c={width:n.width+l.x,height:n.height+l.y,centerX:n.centerX+(e.clientX-s.x)/2,centerY:n.centerY+(e.clientY-s.y)/2};"line"!=t&&"polyline"!=t||(c.points=r),i.trigger("resize",c)}}),e(document).mouseup(function(e){s=null,i=null,a=0,n=null})},removeSelectedView:function(){this.selectedViews.forEach(function(e){e.trigger("removeSelected")}),this.selectedViews=[]},updateAttrBySelectedView:function(){var e=[];this.selectedViews.forEach(function(t){e.push(t.type)}),this.attrView.trigger("showTypeAttr",{types:e})},selectView:function(e,t){if(t){var i=this.selectedViews.indexOf(e);~i?(this.selectedViews.splice(i,1),e.trigger("removeSelected")):(this.selectedViews.push(e),e.trigger("setSelected"))}else{var i=this.selectedViews.indexOf(e);if(~i)return;this.removeSelectedView(),this.selectedViews.push(e),e.trigger("setSelected")}this.updateAttrBySelectedView()},getInsideView:function(e){var i=[];return t.each(this.subViews,function(t){var s=t.svg.bbox(),n=[{x:s.x,y:s.y},{x:s.x2,y:s.y2}];"line"==t.type?o.utils.isRectContain(e,n)&&i.push(t):o.utils.isRectIntersect(e,n)&&i.push(t)}),i},setSelectEvents:function(){var t=this,i=null;isSelecting=!1,insideViews=[],e(document).mousedown(function(s){if(0==s.button){var n=(e(s.target),t.isClickOnAttrEle(s)),o=t.getSelectedViewByTarget(s);n||o?o&&t.selectView(o,s.ctrlKey):(t.selectedViews.length&&t.removeSelectedView(),t.attrView.trigger("showTypeAttr"),t.isClickOnDraw(s)&&(isSelecting=!0,i={x:s.clientX,y:s.clientY}))}}),e(document).mousemove(function(e){if(isSelecting&&i){t.selectTipsBox||(t.selectTipsBox=t.svg.group().addClass("svg-select-tips"));var s=t.domToSvgPos(i),n=t.domToSvgPos({x:e.clientX,y:e.clientY}),r=o.utils.getRectPoints(s,n);t.selectTipsBox.clear(),t.selectTipsBox.rect(Math.abs(n.x-s.x),Math.abs(n.y-s.y)).attr({x:parseInt(r[0].x)+.5,y:parseInt(r[0].y)+.5}).fill("rgba(0, 0, 120, 0.05)").stroke({color:"rgba(0,0,120, 0.8)"}),insideViews=t.getInsideView([r[0],r[2]])}}),e(document).mouseup(function(e){isSelecting=!1,i=null,t.selectTipsBox&&t.selectTipsBox.remove(),t.selectTipsBox=null,insideViews.length&&insideViews.forEach(function(e){t.selectedViews.push(e),e.trigger("setSelected")}),insideViews=[]})},setSelectedItem:function(e){this.clearItemToBeAdd(),this.itemToBeAdd=t.extend({},e)},clearItemToBeAdd:function(){this.elemToBeAdd&&(this.elemToBeAdd=null)},clearSelectedItem:function(){this.itemToBeAdd={type:"",value:""},this.clearItemToBeAdd(),this.toolView.trigger("selectDone"),this.deviceView.trigger("selectDone")},hover:function(e){this.itemToBeAdd.type&&this.itemToBeAdd.value&&this.showItemToBeAdd(e)},showItemToBeAdd:function(e){var t=this.getMousePos(e),i=this.createItem(this.itemToBeAdd,t);this.createItemView(i,{isToBeAdd:!0})},removeItemView:function(){if(this.elemToBeAdd){var e=this.getTypeItem(this.elemToBeAdd.model.toJSON());e.remove(this.elemToBeAdd.model),this.elemToBeAdd.model.destroy()}},addItem:function(e){var t=this.getMousePos(e),i=null;this.itemToBeAdd.type&&this.itemToBeAdd.value&&(this.isClickOnDraw(e)?(i=this.createItem(this.itemToBeAdd,t),this.createItemView(i,{isToBeAdd:!1})):this.removeItemView(),this.clearSelectedItem())},getTypeItem:function(e){return"rect"==e.value||"round-rect"==e.value?this.rectCollections:"line"==e.value||"polyline"==e.value?this.lineCollections:e.value?this.deviceCollections:null},createItem:function(e,t){var i=this.getTypeItem(e),s=null;return s=this.elemToBeAdd?this.elemToBeAdd.model.set({centerX:t.x,centerY:t.y}):i.create({centerX:t.x,centerY:t.y,type:e.type,value:e.value})},createItemView:function(e,t){var i=e.toJSON(),s="";return"device"==i.type?s=i.type:"line"==i.value||"polyline"==i.value?s="line":i.value&&(s="rect"),this.addItemView(s,e,t)},addSubView:function(e){var t=e.id||o.utils.count();this.subViews[t]=e,e.id=t,e.svg.addClass("svg-view").attr("data-id",t)},getSubView:function(e){var t=null;return this.subViews.hasOwnProperty(e)&&(t=this.subViews[e]),t},addItemView:function(e,t,i){var s=null;this.elemToBeAdd?s=this.elemToBeAdd:(this.elemToBeAdd=s=new c[e]({model:t,viewId:o.utils.count()}),this.svg.add(s.render().svg)),i.isToBeAdd||(this.addSubView(s),this.selectView(s))},setAddViewEvents:function(){var t=this;e(document).mousedown(function(e){t.isClickOnDevice(e)?t.deviceView.trigger("setSelected",{event:e}):t.isClickOnTool(e)&&t.toolView.trigger("setSelected",{event:e})}),e(document).mousemove(function(e){t.hover(e)}),e(document).mouseup(function(e){t.addItem(e)})},setBodyEvents:function(){this.setAddViewEvents(),this.setMoveEvents(),this.setResizeEvents(),this.setSelectEvents()},setOtherEvents:function(){this.listenTo(s,"setScale",this.scaleSvg)},scaleSvg:function(e){o.layer.topNotify("info",{content:"scale page "+e.value+"%",shade:!1,time:2})},renderGrid:function(){var e,t=12,s=this.svg.rbox(),n="#f2f2f2",o="#ccc",r=1,a=Math.max(s.width,s.height);for(this.bg?this.bg.clear():this.bg=this.svg.group(),i=0;i<=a;i+=t)i<=s.height&&(e=this.bg.path("M 0 "+i+" L "+s.width+" "+i),i/t%4?e.stroke({color:n}):e.stroke({color:o}),e.transform({y:.5})),i<=s.width&&(e=this.bg.path("M "+i+" 0 L "+i+" "+s.height),i/t%4?e.stroke({color:n,width:r}):e.stroke({color:o,width:r}),e.transform({x:.5}))},render:function(t){var i=e("<div></div>").addClass("draw-content");this.$main.append(i.attr("id","svg-wrapper")),this.svg=n(i[0]).size("100%","100%"),this.renderGrid()},setRightBtnMenu:function(){e(document).contextmenu(function(t){var i=e(t.target);if(i.hasClass("draw-content")||i.parents(".draw-content").length)return o.popupMenu.init(t,f,function(e,t){o.layer.topNotify("info",{content:"operate: "+e+"<br />value: "+t,shade:!1,time:2})}),!1})},initAttr:function(){this.attrView=new r.view({model:new r.model}),this.$main.append(this.attrView.render().el)},initDevice:function(t){this.deviceView=new l.view({model:new l.model,devices:t}),this.$main.append(this.deviceView.render().el);var i=e(".bottom-icons")[0].offsetHeight;e(".draw-content").css("margin-bottom",i+"px"),this.listenTo(this.deviceView,"selectDevice",this.setSelectedItem)},initTool:function(e){this.toolView=new a.view({model:new a.model,tools:e}),this.$main.find(".top-attrs").after(this.toolView.render().el),this.listenTo(this.toolView,"selectTool",this.setSelectedItem)}}),p=null;window.Draw={checkData:function(e){return e},init:function(e,t){var i=this.checkData(e);p=new v(i)},save:function(e){},setEvent:function(e,t,i){}},Draw.init({el:".outer-container",isEdit:!0,tools:[{type:"rect",name:"矩形"},{type:"round-rect",name:"圆角矩形"},{type:"line",name:"直线"},{type:"polyline",name:"折线"}],devices:[{type:2,name:"接地设备",src:"./imgs/2.svg",devices:[{id:1,name:"jack-1jack-1jack-1",available:!0},{id:2,name:"jack-2",available:!0},{id:3,name:"jack-3",available:!0}]},{type:3,name:"接地设备",src:"./imgs/3.svg"},{type:4,name:"接地设备",src:"./imgs/4.svg"},{type:5,name:"接地设备",src:"./imgs/5.svg"}]},function(){o.layer.topNotify("success",{content:"draw inited",shade:!1,time:2})})}),define("draw",function(){});
//# sourceMappingURL=main.js.map